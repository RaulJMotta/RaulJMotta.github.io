<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-t" />
    <title>Walkability Index Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f0f0;
        }

        #controls {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-size: 11px;
            font-weight: bold;
            color: #666;
            margin-bottom: 4px;
        }
        
        .control-group select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        #map {
            width: 100%;
            height: 100vh;
        }
        
        /* Estilos da Legenda */
        .legend {
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,.2);
            font-size: 12px;
            color: #555;
            width: 250px; /* Largura definida */
            /* NOVO: Posicionamento fixo para a legenda */
            position: fixed; /* Fixa a legenda na tela */
            bottom: 10px; /* 10px do fundo */
            right: 10px; /* 10px da direita */
            z-index: 999; /* Garante que fique acima do mapa */
        }
        .legend-title {
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
        }
        .legend-bar {
            display: flex;
            height: 15px;
            border-radius: 3px;
            overflow: hidden;
        }
        .legend-bar span {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .legend-q1 { background: #d73027; }
        .legend-q2 { background: #fdae61; }
        .legend-q3 { background: #91cf60; }
        .legend-q4 { background: #1a9850; }

        .legend-labels {
            position: relative;
            height: 35px;
            margin-top: 5px;
        }
        .legend-labels span {
            position: absolute;
            top: 0;
            width: 60px;
            text-align: center;
            white-space: nowrap;
        }

        .legend-labels .label-start { left: 0; text-align: left; }
        .legend-labels .label-q1 { left: 25%; transform: translateX(-50%); }
        .legend-labels .label-q2 { left: 50%; transform: translateX(-50%); }
        .legend-labels .label-q3 { left: 75%; transform: translateX(-50%); }
        .legend-labels .label-end { right: 0; text-align: right; }

        .legend-labels small {
            display: block;
            font-size: 10px;
            color: #777;
            margin-top: 2px;
        }

        /* --- ESTILOS PARA A CAIXA DE INFORMAÇÃO (COM ANIMAÇÃO DE DESLIZE) --- */
        #info-box {
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,.2);
            width: 250px;
            position: fixed;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 999;
            
            /* NOVO: Adiciona a animação de transição */
            transition: transform 0.4s ease-in-out;
        }

        /* NOVO: Estado "recolhido" da caixa */
        #info-box.collapsed {
            /* Desliza a caixa para a direita, deixando apenas 35px da aba visível */
            transform: translate(calc(100% + 10px), -50%);
        }

        .info-box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 8px;
        }

        #info-box-title {
            margin: 0;
            font-size: 14px;
            color: #333;
        }

        /* NOVO: Estilo da aba/botão */
        #info-box-toggle {
            position: absolute;
            left: -35px; /* Posiciona a aba para fora da caixa, à esquerda */
            top: 50%;
            transform: translateY(-50%);
            width: 35px;
            height: 60px;
            background-color: white;
            border: none;
            border-radius: 8px 0 0 8px; /* Cantos arredondados apenas na esquerda */
            box-shadow: -2px 1px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            
            display: flex;
            align-items: center;
            justify-content: center;
            
            font-size: 20px;
            color: #555;
            padding: 0;
            padding-right: 2px; /* Pequeno ajuste visual da seta */
        }
        #info-box-toggle:hover {
            background-color: #f7f7f7;
        }


        #info-box-content {
            font-size: 12px;
            margin: 0;
            line-height: 1.5;
            color: #555;
            transition: all 0.2s ease;
        }

        /* Adiciona uma transição suave de opacidade para o conteúdo */
        .info-box-header, #info-box-content {
            transition: opacity 0.2s ease-in-out;
        }

        /* Quando a caixa estiver recolhida, torna o conteúdo invisível */
        #info-box.collapsed .info-box-header,
        #info-box.collapsed #info-box-content {
            opacity: 0;
            pointer-events: none; /* Impede cliques em elementos invisíveis */
        }


    </style>
</head>
<body>

    <div id="controls">
        <div class="control-group">
            <label for="city-select">City</label>
            <select id="city-select">
                <option value="POA">Porto Alegre</option>
                <option value="Concepcion">Concepción</option>
                <option value="Barranquilla">Barranquilla</option>
            </select>
        </div>
        <div class="control-group">
            <label for="attribute-select">Attribute</label>
            <select id="attribute-select">
                </select>
        </div>
    </div>

    <div id="map"></div>

    <div id="info-box">
        <button id="info-box-toggle" title="Hide/Show Information">&raquo;</button>

        <div class="info-box-header">
            <h4 id="info-box-title"></h4>
            </div>
        <p id="info-box-content"></p>
    </div>

    <script>

        // --- VARIÁVEIS GLOBAIS ---
        let map;
        let geojsonLayer = null;
        let legendControl = null;
        let allData = null;
        let cityData = {};
        let quartileBreaks = {};

        const citySelector = document.getElementById('city-select');
        const attributeSelector = document.getElementById('attribute-select');
        
        // NOVO: Referências para a caixa de informação
        const infoBoxTitle = document.getElementById('info-box-title');
        const infoBoxContent = document.getElementById('info-box-content');
        const infoBoxToggle = document.getElementById('info-box-toggle');

        const attributeMap = {
            'F0_WI': 'Walkability Index',
            'F1_DELSIDE': 'Delimited Sidewalks',
            'F2_SIDEWID': 'Sidewalk Width',
            'F3_QUALITY': 'Quality of Pavement',
            'F4_INFRA': 'Pedestrian Infrastructure(Vulnearable People)',
            'F5_OBSTACL': 'Obstacles on Sidewalk/Vehicles Parked on Sidewalks',
            'F6_VEHSPEE': 'Vehicle Speed',
            'F7_TRAFFIC': 'Traffic Flow',
            'F8_TRAFFIC': 'Presence of Traffic Control Devices/Crosswalks',
            'F9_TRAFFIC': 'Crashes',
            'F10_CROSST': 'Crossing Time',
            'F11_CAMERA': 'Presence of Security Cameras/Officers/Police Stations',
            'F12_PEDFLO': 'Pedestrian Flow',
            'F13_CRIMES': 'Number of Crimes',
            'F14_LIGHT': 'Quality of Lighting',
            'F15_COMMER': 'Commercial',
            'F16_INSTIT': 'Institutional',
            'F17_RESIDE': 'Residential',
            'F18_PUBLIC': 'Public Transport',
            'F19_GREENA': 'Green Areas',
            'F20_TREES': 'Presence of Trees',
            'F21_AESTHE': 'Aesthetics of Buildings ',
            'F22_CLEANL': 'Cleanliness',
            'F23_AIRPOL': 'Air Pollution',
            'F24_WATER': 'Stagnant Water',
            'F25_NOISE': 'Noise',
            'F26_SLOPE': 'Slope',
            'F27_LENGTH': 'Block Lenght(Normalized)'
        };

        // NOVO: Objeto com as descrições de cada atributo
        const attributeDescriptions = {
            'F0_WI': "The <strong>Walkability Index</strong> measures how well a city's sidewalks provide a safe, continuous, and comfortable walking experience for pedestrians.",
            'F1_DELSIDE': "<strong>Measurement:</strong><br>Presence of delimeted sidewalk segments on the city's road network<br><br><strong>Range Value and Variable:</strong><br>1 - The edge of the sidewalk is clearly defined by a curb or a physical separation that distinguishes it from the roadway.<br>0 - The edge of the sidewalk is NOT clearly defined",
            'F2_SIDEWID': "<strong>Measurement:</strong><br>Sidewalk width evaluation (in meters)<br><br><strong>Range Value and Variable:</strong><br>1 - L ≥ 3 m<br>0.5 - 1,5 m ≤ L < 3 m<br>0 - L ≤ 1,5 m",
            'F3_QUALITY': "<strong>Measurement:</strong><br>Presence of cracks and/or gaps<br><br><strong>Range Value and Variable:</strong><br>1 - Sidewalk suitable for walking or jogging<br>0.5 - Practicable sidewalk but with caution<br>0 - Sidewalk in bad condition or no presence of a sidewalk",
            'F4_INFRA': "<strong>Measurement:</strong><br>Presence of ramps or special infrastructure for the vulnerable people<br><br><strong>Range Value and Variable:</strong><br>1 - Yes<br>0 - No",
            'F5_OBSTACL': "<strong>Measurement:</strong><br>Evaluation of the sidewalk remaining width<br><br><strong>Range Value and Variable:</strong><br>1 - No obstacles: The sidewalk has no obstacles that reduce its effective width<br>0.5 - Few: The sidewalk has obstacles that reduce its effective width in less than 50% of the evaluated segment.<br>0 - A lot: The sidewalk has obstacles that reduce its effective width in more than 50% of the evaluated segment",
            'F6_VEHSPEE': "<strong>Measurement:</strong><br>Average traffic speed (in km/h)<br><br><strong>Range Value and Variable:</strong><br>1 - V ≤ 20 km/h<br>0.5 - 20 km/h < V ≤ 40 km/h<br>0 - v > 40km/h",
            'F7_TRAFFIC': "<strong>Measurement:</strong><br>Vehicular flow (veh/h)<br><br><strong>Range Value and Variable:</strong><br>1 - Free-flowing, no vehicles passing by<br>0.5 - Moderate<br>0 - Congested, a lot of vehicles passing by",
            'F8_TRAFFIC': "<strong>Measurement:</strong><br>Are there traffic control devices in the segment?<br><br><strong>Range Value and Variable:</strong><br>1 - Yes (at least one traffic light or crosswalk)<br>0 - No",
            'F9_TRAFFIC': "<strong>Measurement:</strong><br>Are there traffic crashes in the segment?<br><br><strong>Range Value and Variable:</strong><br>1 - A lot of accidents<br>0.5 - Some accidents (limit of interval depends on the number of accidents in general)<br>0 - No (zero accidents)",
            'F10_CROSST': "<strong>Measurement:</strong><br>Walking time from sidewalk to sidewalk(in sec)(Street width/pedestrian speed:1m/s)<br><br><strong>Range Value and Variable:</strong><br>1 - t < 5s<br>0.5 - 5 < t < 30s<br>0 - t > 30s",
            'F11_CAMERA': "<strong>Measurement:</strong><br>Are there are security cameras/officers/police station in the segment?<br><br><strong>Range Value and Variable:</strong><br>1 - Yes<br>0 - No",
            'F12_PEDFLO': "<strong>Measurement:</strong><br>Number of pedestrians<br><br><strong>Range Value and Variable:</strong><br>1 - High<br>0.5 - Moderate<br>0 - Low",
            'F13_CRIMES': "<strong>Measurement:</strong><br>Presence of robberies, crimes, and/or homicides<br><br><strong>Range Value and Variable:</strong><br>1 - Absent<br>0 - Present (There are occurrences of robberies, crimes, and/or homicides in the area.)",
            'F14_LIGHT': "<strong>Measurement:</strong><br>Night lighting presence<br><br><strong>Range Value and Variable:</strong><br>1 - Covered area with excellent lighting<br>0.5 -  The current lighting allows for clear visibility in most areas, but there are some parts that have deficiencies or need improvement.<br>0 - No public lighting",
            'F15_COMMER': "<strong>Measurement:</strong><br>The density of commercial establishments<br><br><strong>Range Value and Variable:</strong><br>0 - Less than 300 commerc/km²<br>0.5 - Between 300 and 2000 commerc/km²<br>1 - More than 2000 commerc/km²",
            'F16_INSTIT': "<strong>Measurement:</strong><br>The density of institutional establishments<br><br><strong>Range Value and Variable:</strong><br>0 - <br>0.5 - <br>1 - ",
            'F17_RESIDE': "<strong>Measurement:</strong><br>Population density<br><br><strong>Range Value and Variable:</strong><br>0 - Low density: < 2500 hab/km²<br>0,5 - Medium density: 2500 - 13000 hab/km²<br>1 - High density: > 13000 hab/km²",
            'F18_PUBLIC': "<strong>Measurement:</strong><br>Is there public transport (stops, stations) in the grid?<br><br><strong>Range Value and Variable:</strong><br>1 - Yes<br>0 - No",
            'F19_GREENA': "<strong>Measurement:</strong><br>Is there green areas (any size, at least a small part of a park) in the grid?<br><br><strong>Range Value and Variable:</strong><br>1 - Yes<br>0 - No",
            'F20_TREES': "<strong>Measurement:</strong><br>Presence of trees <br><br><strong>Range Value and Variable:</strong><br>1 - Yes(at least 3 trees in ~100 m)<br>0 - No",
            'F21_AESTHE': "<strong>Measurement:</strong><br>Quality of the urban environment<br><br><strong>Range Value and Variable:</strong><br>1 - Pleasant environment with well-preserved buildings and urban furniture. The area is well-designed with thoughtful landscape architecture. Businesses, if present, have decorated or renovated facades and windows.<br>0.5 - Environment with an average environmental standard. The area has a mild atmosphere, reasonably preserved buildings, and minimal street furniture. Businesses, if present, have reasonably attractive facades and windows.<br>0 - Unattractive environment with no concern for aesthetic and visual aspects. Buildings are poorly maintained or degraded, and urban furniture is minimal or non-existent.",
            'F22_CLEANL': "<strong>Measurement:</strong><br>Cleaniless of the environment/Presence of rubbish<br><br><strong>Range Value and Variable:</strong><br>1 - Clean environment<br>0.5 - Small litter on the sidewalk in some sections (paper, cans, bottles, etc.)<br>0 - Large rubbish items, including cans and garbage bags, left on the sidewalk.",
            'F23_AIRPOL': "<strong>Measurement:</strong><br>Air Quality Index in the area<br><br><strong>Range Value and Variable:</strong><br>1 - AQI Good or Moderate (below the limit value recommended by the WHO 24-hour air quality guidelines)<br>0 - AQI Poor, Unhealthy, Severe, Hazardous",
            'F24_WATER': "<strong>Measurement:</strong><br>Presence of stagnant water<br><br><strong>Range Value and Variable:</strong><br>1 - Yes<br>0 - No",
            'F25_NOISE': "<strong>Measurement:</strong><br>Qualitative<br><br><strong>Range Value and Variable:</strong><br>1 - Low: The noise level is minimal and barely noticeable.<br>0.5 - Moderate: The noise level is noticeable but not create a feeling of discomfort. <br>0 - High: Constant traffic noise, honking and other sounds",
            'F26_SLOPE': "<strong>Measurement:</strong><br>Segment slope<br><br><strong>Range Value and Variable:</strong><br>1 - Slope < 2%<br>0.5 - Slope between 2% — 3%<br>0 - Slope > %3",
            'F27_LENGTH': "<strong>Measurement:</strong><br>Average block length, <br><br><strong>Range Value and Variable:</strong><br>Normalized block lenght calculated by dividing each segment's length by the length of the longest segment in the dataset<br><br>1 - Longer segment<br>0 - Shorter segment"
        };

        // --- FUNÇÕES DE LÓGICA DO MAPA ---

        function initMap() {
            map = L.map('map').setView([-22.9, -43.2], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        function getColor(value, breaks) {
            if (value === undefined || value === null) return '#000000'; // Preto para dados faltantes
            if (!breaks || breaks.q3 === undefined) return '#808080';
            return value <= breaks.q1 ? '#d73027' :
                value <= breaks.q2 ? '#fdae61' :
                value <= breaks.q3 ? '#91cf60' :
                                        '#1a9850';
        }

        function styleFeature(feature) {
            const selectedAttribute = attributeSelector.value;
            const props = feature.properties;
            
            if (selectedAttribute === 'F0_WI') {
                const value = props.F0_WI;
                return { color: getColor(value, quartileBreaks), weight: 4, opacity: 0.9 };
            } else {
                const value = props[selectedAttribute];
                const fixedBreaks = { q1: 0.25, q2: 0.50, q3: 0.75 };
                return { color: getColor(value, fixedBreaks), weight: 3, opacity: 0.8 };
            }
        }

        function onEachFeature(feature, layer) {
            layer.bindPopup(() => {
                const selectedAttributeKey = attributeSelector.value;
                const props = feature.properties;
                const value = props[selectedAttributeKey];
                const address = props.NMIDELOG;
                const displayName = attributeMap[selectedAttributeKey] || selectedAttributeKey;
                let formattedValue;
                if (typeof value === 'number' && !isNaN(value)) {
                    formattedValue = (selectedAttributeKey === 'F0_WI') ? value.toFixed(3) : value.toFixed(2);
                } else {
                    formattedValue = (value === null || value === undefined) ? 'No Data' : value;
                }
                return `<b>Street Name:</b><br>${address ? address : 'No Data'}<br><br><b>${displayName}:</b><br>${formattedValue}`;
            });
            layer.on('mouseover', function (e) { this.openPopup(e.latlng); });
            layer.on('mouseout', function () { this.closePopup(); });
        }
        
        function calculateQuartiles(data, field) {
            const values = data.features.map(f => f.properties[field]).filter(v => v !== null && !isNaN(v)).sort((a, b) => a - b);
            if (values.length < 4) return { q1: null, q2: null, q3: null };
            const q1Index = Math.floor(values.length / 4);
            const q2Index = Math.floor(values.length / 2);
            const q3Index = Math.floor(values.length * 3 / 4);
            return { q1: values[q1Index], q2: values[q2Index], q3: values[q3Index] };
        }

        function updateLegend() {
            if (legendControl) { map.removeControl(legendControl); legendControl = null; }
            const selectedAttributeKey = attributeSelector.value;
            const selectedAttributeName = attributeMap[selectedAttributeKey] || selectedAttributeKey;
            let breaks;
            let title = selectedAttributeName;
            if (selectedAttributeKey === 'F0_WI') {
                if (!quartileBreaks.q1) return;
                breaks = quartileBreaks;
            } else {
                breaks = { q1: 0.25, q2: 0.50, q3: 0.75 };
            }
            legendControl = L.control({ position: 'bottomright' });
            legendControl.onAdd = function () {
                var div = L.DomUtil.create('div', 'legend');
                const q1Text = breaks.q1.toFixed(selectedAttributeKey === 'F0_WI' ? 3 : 2);
                const q2Text = breaks.q2.toFixed(selectedAttributeKey === 'F0_WI' ? 3 : 2);
                const q3Text = breaks.q3.toFixed(selectedAttributeKey === 'F0_WI' ? 3 : 2);
                const showBarText = selectedAttributeKey === 'F0_WI';
                div.innerHTML = `<div class="legend-title">${title}</div><div class="legend-bar"><span class="legend-q1">${showBarText ? 'Q1' : ''}</span><span class="legend-q2">${showBarText ? 'Q2' : ''}</span><span class="legend-q3">${showBarText ? 'Q3' : ''}</span><span class="legend-q4">${showBarText ? 'Q4' : ''}</span></div><div class="legend-labels"><span class="label-start">0<small>Bad</small></span><span class="label-q1">${q1Text}</span><span class="label-q2">${q2Text}</span><span class="label-q3">${q3Text}</span><span class="label-end">1<small>Good</small></span></div>`;
                return div;
            };
            legendControl.addTo(map);
        }
        
        // NOVO: Função para atualizar o conteúdo da caixa de informação
        function updateInfoBox() {
            const selectedKey = attributeSelector.value;
            // Atualiza o título e o conteúdo da caixa
            infoBoxTitle.textContent = attributeMap[selectedKey] || selectedKey;
            infoBoxContent.innerHTML = attributeDescriptions[selectedKey] || "Descrição não disponível.";
        }

        function displayCity() {
            const selectedCity = citySelector.value;
            const cityGeoJSON = cityData[selectedCity];
            if (!cityGeoJSON) return;
            if (geojsonLayer) { map.removeLayer(geojsonLayer); }
            quartileBreaks = calculateQuartiles(cityGeoJSON, 'F0_WI');
            geojsonLayer = L.geoJSON(cityGeoJSON, { style: styleFeature, onEachFeature: onEachFeature }).addTo(map);
            if (cityGeoJSON.features.length > 0) { map.fitBounds(geojsonLayer.getBounds().pad(0.1)); }
            updateLegend();
            updateInfoBox(); // NOVO: Chama a função para atualizar a caixa de info
        }

        // --- INICIALIZAÇÃO E CARREGAMENTO DE DADOS ---
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            
            fetch("meu_mapa.geojson")
                .then(response => response.json())
                .then(data => {
                    allData = data;
                    cityData.POA = { type: "FeatureCollection", features: data.features.filter(f => f.properties.layer.trim().replace(/\s+/g, ' ') === 'Vias final POA') };
                    cityData.Concepcion = { type: "FeatureCollection", features: data.features.filter(f => f.properties.layer.trim() === 'eje_central_Concepcion') };
                    cityData.Barranquilla = { type: "FeatureCollection", features: data.features.filter(f => f.properties.layer.trim() === 'Baranquilla') };
                    
                    const attributesToShow = ['F0_WI', 'F1_DELSIDE', 'F2_SIDEWID', 'F3_QUALITY', 'F4_INFRA', 'F5_OBSTACL', 'F6_VEHSPEE', 'F7_TRAFFIC', 'F8_TRAFFIC', 'F9_TRAFFIC', 'F10_CROSST', 'F11_CAMERA', 'F12_PEDFLO', 'F13_CRIMES', 'F14_LIGHT', 'F15_COMMER', 'F16_INSTIT', 'F17_RESIDE', 'F18_PUBLIC', 'F19_GREENA', 'F20_TREES', 'F21_AESTHE', 'F22_CLEANL', 'F23_AIRPOL', 'F24_WATER', 'F25_NOISE', 'F26_SLOPE', 'F27_LENGTH'];
                    attributesToShow.forEach(propKey => {
                        const option = document.createElement('option');
                        option.value = propKey;
                        option.textContent = attributeMap[propKey] || propKey; 
                        attributeSelector.appendChild(option);
                    });
                    
                    // --- NOVA LÓGICA PARA O BOTÃO DE ALTERNÂNCIA ---
                    const infoBox = document.getElementById('info-box'); // Pega a referência da caixa inteira
                    infoBoxToggle.addEventListener('click', () => {
                        const infoBox = document.getElementById('info-box');
                        infoBox.classList.toggle('collapsed');

                        const isCollapsed = infoBox.classList.contains('collapsed');
                        // Usa as setas duplas
                        infoBoxToggle.innerHTML = isCollapsed ? '&laquo;' : '&raquo;';
                    });

                    citySelector.addEventListener('change', displayCity);
                    
                    attributeSelector.addEventListener('change', () => {
                        if (geojsonLayer) {
                            geojsonLayer.setStyle(styleFeature);
                            updateLegend();
                            updateInfoBox();
                        }
                    });

                    displayCity(); // Exibe a cidade padrão ao carregar
                })
                .catch(error => console.error("Erro ao carregar o GeoJSON:", error));
        });
    </script>
</body>
</html>
